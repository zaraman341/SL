function t(t){return t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,"$1")}function e(t,e){let a=1,s=!1,n="";for(let r=e;r<t.length;r++){const e=t[r],o=r>0?t[r-1]:"";if('"'!==e&&"'"!==e&&"`"!==e||"\\"===o||(s?e===n&&(s=!1):(s=!0,n=e)),!s)if("("===e)a++;else if(")"===e&&(a--,0===a))return r}return-1}function a(t){const e=[];let a="",s=!1,n="",r=0,o=0;for(let i=0;i<t.length;i++){const l=t[i];'"'!==l&&"'"!==l&&"`"!==l||0!==i&&"\\"===t[i-1]||(s?l===n&&(s=!1):(s=!0,n=l)),"["===l&&r++,"]"===l&&r--,"{"===l&&o++,"}"===l&&o--,","!==l||s||0!==r||0!==o?a+=l:(e.push(a.trim()),a="")}return a.trim()&&e.push(a.trim()),e}async function s(t){for(;!(t<0);){var e=await getChatMessages(t);if(e.length>0){var a=e[0].data;if(_.has(a,"stat_data"))return a}--t}return await getVariables()}function n(t){const e=[];let a="",s=!1,n="";for(let r=0;r<t.length;r++){const o=t[r];'"'!==o&&"'"!==o||0!==r&&"\\"===t[r-1]?"."!==o||s?a+=o:(e.push(a),a=""):s?o===n?s=!1:a+=o:(s=!0,n=o)}return a&&e.push(a),e.join(".")}async function r(s,r){var o=!1;await eventEmit(l.VARIABLE_UPDATE_STARTED,r,o);var i=_.cloneDeep(r),c={},d=function(s){const n=[];let r=0;for(;r<s.length;){const o=s.indexOf("_.set(",r);if(-1===o)break;const i=o+6;let l=e(s,i);if(-1===l){r=i+1;continue}let c=l+1;if(c<s.length&&";"===s[c]){for(c++;c<s.length&&" "===s[c];)c++;let e="";if(c+1<s.length&&"/"===s[c]&&"/"===s[c+1]){const t=s.indexOf("\n",c);-1!==t?(e=s.substring(c+2,t).trim(),c=t):(e=s.substring(c+2).trim(),c=s.length)}const _=s.substring(i,l),d=s.substring(o,c),u=a(_);u.length>=3?n.push({fullMatch:d,path:t(u[0]),oldValue:t(u[1]),newValue:t(u[2]),reason:e}):2===u.length&&n.push({fullMatch:d,path:t(u[0]),oldValue:t(u[1]),newValue:t(u[1]),reason:e}),r=c}else r=l+1}return n}(s),u=!1;for(const e of d){var{path:f,newValue:g,reason:h}=e;if(f=n(f),_.has(r.stat_data,f)){const e=_.get(r.stat_data,f);if(_.isString(g)&&g.trim().startsWith("[")&&g.trim().endsWith("]"))try{const t=JSON.parse(g);Array.isArray(t)&&t.length>0&&(g=t[0])}catch(t){console.error(`Error parsing JSON array for '${f}': ${t.message}`)}if("number"==typeof e){const t=Number(g),a=e;_.set(r.stat_data,f,t);const s=h?`(${h})`:"",n=`${a}->${t} ${s}`;_.set(i.stat_data,f,n),_.set(c,f,n),u=!0,console.info(`Set '${f}' to '${t}' ${s}`),await eventEmit(l.SINGLE_VARIABLE_UPDATED,r.stat_data,f,a,t)}else if(Array.isArray(e)&&2===e.length){const a="number"==typeof e[0]?Number(g):t(g),s=_.cloneDeep(e[0]);e[0]=a,_.set(r.stat_data,f,e);const n=h?`(${h})`:"",o=`${s}->${g} ${n}`;_.set(i.stat_data,f,o),_.set(c,f,o),u=!0,console.info(`Set '${f}' to '${a}' ${n}`),await eventEmit(l.SINGLE_VARIABLE_UPDATED,r.stat_data,f,s,a)}else{const a=t(g),s=_.cloneDeep(e);_.set(r.stat_data,f,a);const n=h?`(${h})`:"",o=`${s}->${a} ${n}`;_.set(i.stat_data,f,o),_.set(c,f,o),u=!0,console.info(`Set '${f}' to '${a}' ${n}`),await eventEmit(l.SINGLE_VARIABLE_UPDATED,r.stat_data,f,s,a)}}else{const t=`undefined Path: ${f}->${g} (${h})`;console.error(t)}}return r.display_data=i.stat_data,r.delta_data=c,await eventEmit(l.VARIABLE_UPDATE_ENDED,r,o),u||o}async function o(){const t=await getLastMessageId();var e=await getChatMessages(t);if(e.length>0){var a=e[e.length-1];if("assistant"!=a.role)return;var n=!1,o=a.message;const l=await s(t-1);if(!_.has(l,"stat_data"))return void console.error("cannot found stat_data.");var i=!1;if((i=i||await r(o,l))&&await replaceVariables(l),await setChatMessage({data:l},t,{refresh:"none"}),!o.includes("<CharView")&&!o.includes("<StatusPlaceHolderImpl/>"))if(o.includes("<StatusPlaceHolder/>")){const t="<StatusPlaceHolderImpl/>";o=o.replace("<StatusPlaceHolder/>",t),n=!0}else{o+="\n\n"+"<StatusPlaceHolderImpl/>",n=!0}n&&(console.info("Replace content...."),await setChatMessage({message:o},t,{refresh:"display_and_render_current"}))}}async function i(){var t=[];try{await getChatMessages(-2,{role:"assistant",include_swipes:!0})}catch(t){}if(t||(t=[]),t.length<=0){var e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))return void console.error("不存在任何一条消息，退出");t=e}var a=t[0],s=a.swipes_data[a.swipe_id],n=(await getLorebookSettings()).selected_global_lorebooks,o=await getCurrentCharPrimaryLorebook();null!==o&&n.push(o),void 0===s&&(s={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}),_.has(s,"initialized_lorebooks")||(s.initialized_lorebooks=[]),s.stat_data||(s.stat_data={});var i=!1;for(const t of n)if(!s.initialized_lorebooks.includes(t)){s.initialized_lorebooks.push(t);var l=await getLorebookEntries(t);for(const t of l)if(t.comment?.toLowerCase().includes("[initvar]"))try{const e=JSON.parse(substitudeMacros(t.content));s.stat_data=_.merge(s.stat_data,e)}catch(t){return console.error(`Failed to parse JSON from lorebook entry: ${t}`),void toastr.error(t.message,"Failed to parse JSON from lorebook entry",{timeOut:5e3})}i=!0}if(!i)return;console.info("Init chat variables."),await insertOrAssignVariables(s);for(var c=0;c<a.swipes.length;c++){var d=_.cloneDeep(s);await r(substitudeMacros(a.swipes[c]),d),await setChatMessage({data:d},a.message_id,{refresh:"none",swipe_id:c})}const u={context_percentage:100,recursive:!0},f=await getLorebookSettings();_.isEqual(_.merge({},f,u),f)&&setLorebookSettings(u)}eventOn(tavern_events.GENERATION_ENDED,o),eventOn(tavern_events.MESSAGE_SENT,i),eventOn(tavern_events.MESSAGE_SENT,(async function(){try{const t=await getLastMessageId(),e=await getChatMessages(t);if(!e||0===e.length)return;const a=e[e.length-1];if("user"!==a.role)return;const n=await s(t-1);if(!_.has(n,"stat_data"))return void console.log("User message handler: No stat_data found to modify.");await r(a.message,n)&&(console.info("Variables updated by user message."),await setChatMessage({data:n},t,{refresh:"none"}))}catch(t){console.error("Error in handleUserMessage:",t)}})),eventOn(tavern_events.GENERATION_STARTED,i);const l={SINGLE_VARIABLE_UPDATED:"mag_variable_updated",VARIABLE_UPDATE_ENDED:"mag_variable_update_ended",VARIABLE_UPDATE_STARTED:"mag_variable_update_started"};window.handleResponseMessage=o;export{l as variable_events};
//# sourceMappingURL=bundle.js.map